#!/bin/bash

echo "üöÄ Arbitron Deploy - EC2: 18.219.161.129"
echo "========================================"

# Definir IP p√∫blico
PUBLIC_IP="18.219.161.129"

# Cores para logs
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

log_info "Configurando Arbitron para IP: $PUBLIC_IP"

# Atualizar sistema
log_info "Atualizando sistema Ubuntu..."
sudo apt update && sudo apt upgrade -y

# Instalar depend√™ncias
log_info "Instalando depend√™ncias essenciais..."
sudo apt install -y curl wget git unzip software-properties-common apt-transport-https ca-certificates gnupg lsb-release

# Instalar Docker
log_info "Instalando Docker..."
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Adicionar usu√°rio ao grupo docker
sudo usermod -aG docker $USER

# Instalar Docker Compose
log_info "Instalando Docker Compose..."
sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Configurar firewall
log_info "Configurando firewall UFW..."
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3000/tcp
sudo ufw allow 8000/tcp
sudo ufw allow 3001/tcp
sudo ufw --force enable

# Clonar reposit√≥rio Arbitron
log_info "Clonando reposit√≥rio Arbitron..."
cd /home/$USER
rm -rf Arbitron
git clone https://github.com/MauricioJSNeto/Arbitron.git
cd Arbitron

# Gerar chaves de seguran√ßa
log_info "Gerando chaves de seguran√ßa..."
JWT_SECRET=$(openssl rand -hex 32)
REFRESH_SECRET=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)
DB_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)

# Criar arquivo .env principal
log_info "Configurando vari√°veis de ambiente..."
cat > .env << EOF
# Arbitron - AWS EC2 Configuration
# IP: 18.219.161.129
PROJECT_NAME=Arbitron
NODE_ENV=production
PUBLIC_IP=$PUBLIC_IP

# URLs de acesso
NEXT_PUBLIC_API_URL=http://$PUBLIC_IP:8000
NEXT_PUBLIC_SECURITY_URL=http://$PUBLIC_IP:3001
NEXT_PUBLIC_WS_URL=ws://$PUBLIC_IP:8000/ws

# Seguran√ßa
JWT_SECRET=$JWT_SECRET
REFRESH_TOKEN_SECRET=$REFRESH_SECRET
ENCRYPTION_KEY=$ENCRYPTION_KEY

# Banco de dados
POSTGRES_USER=arbitron_user
POSTGRES_PASSWORD=$DB_PASSWORD
POSTGRES_DB=arbitron_db
DATABASE_URL=postgresql://arbitron_user:$DB_PASSWORD@postgres:5432/arbitron_db

# Redis
REDIS_URL=redis://redis:6379

# Configura√ß√µes do bot
MIN_PROFIT_THRESHOLD=0.5
MAX_TRADE_AMOUNT=100
SIMULATION_MODE=true

# APIs das Exchanges (CONFIGURE SUAS CHAVES REAIS)
BINANCE_API_KEY=your_binance_api_key_here
BINANCE_SECRET_KEY=your_binance_secret_key_here
KRAKEN_API_KEY=your_kraken_api_key_here
KRAKEN_SECRET_KEY=your_kraken_secret_key_here

# Configura√ß√µes de email (opcional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
EOF

# Criar .env para security-backend
log_info "Configurando security backend..."
mkdir -p security-backend
cat > security-backend/.env << EOF
PORT=3001
NODE_ENV=production
JWT_SECRET=$JWT_SECRET
JWT_EXPIRES_IN=15m
REFRESH_TOKEN_SECRET=$REFRESH_SECRET
REFRESH_TOKEN_EXPIRES_IN=7d
ENCRYPTION_KEY=$ENCRYPTION_KEY
DATABASE_URL=postgresql://arbitron_user:$DB_PASSWORD@postgres:5432/arbitron_security_db
CORS_ORIGIN=http://$PUBLIC_IP:3000
EOF

# Criar docker-compose otimizado para EC2
log_info "Criando configura√ß√£o Docker Compose..."
cat > docker-compose.prod.yml << EOF
version: '3.8'

services:
  frontend:
    build: 
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://$PUBLIC_IP:8000
      - NEXT_PUBLIC_SECURITY_URL=http://$PUBLIC_IP:3001
      - NEXT_PUBLIC_WS_URL=ws://$PUBLIC_IP:8000/ws
    depends_on:
      - security-backend
      - arbitrage-engine
    networks:
      - arbitron-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  security-backend:
    build: 
      context: ./security-backend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    env_file:
      - security-backend/.env
    depends_on:
      - postgres
    networks:
      - arbitron-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  arbitrage-engine:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_URL=postgresql://arbitron_user:$DB_PASSWORD@postgres:5432/arbitron_arbitrage_db
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - PUBLIC_IP=$PUBLIC_IP
    depends_on:
      - redis
      - postgres
    networks:
      - arbitron-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:13
    environment:
      - POSTGRES_USER=arbitron_user
      - POSTGRES_PASSWORD=$DB_PASSWORD
      - POSTGRES_DB=arbitron_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - arbitron-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arbitron_user -d arbitron_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - arbitron-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:

networks:
  arbitron-net:
    driver: bridge
EOF

# Criar script de inicializa√ß√£o
log_info "Criando scripts de controle..."
cat > start-arbitron.sh << 'EOF'
#!/bin/bash

echo "üöÄ Iniciando Arbitron - IP: 18.219.161.129"
echo "=========================================="

# Aplicar permiss√µes Docker (necess√°rio ap√≥s instala√ß√£o)
sudo systemctl start docker
sudo systemctl enable docker

# Parar containers existentes
docker-compose -f docker-compose.prod.yml down

# Limpar sistema Docker
docker system prune -f

# Construir e iniciar servi√ßos
echo "üî® Construindo containers..."
docker-compose -f docker-compose.prod.yml build --no-cache

echo "üöÄ Iniciando servi√ßos..."
docker-compose -f docker-compose.prod.yml up -d

# Aguardar inicializa√ß√£o
echo "‚è≥ Aguardando inicializa√ß√£o dos servi√ßos..."
sleep 60

# Verificar status
echo "üîç Verificando status dos servi√ßos..."

if curl -f -s http://localhost:3000 > /dev/null; then
    echo "‚úÖ Frontend: http://18.219.161.129:3000"
else
    echo "‚ùå Frontend n√£o est√° respondendo"
fi

if curl -f -s http://localhost:8000/health > /dev/null; then
    echo "‚úÖ API: http://18.219.161.129:8000/docs"
else
    echo "‚ùå API n√£o est√° respondendo"
fi

if curl -f -s http://localhost:3001/health > /dev/null; then
    echo "‚úÖ Security: http://18.219.161.129:3001/health"
else
    echo "‚ùå Security Backend n√£o est√° respondendo"
fi

echo ""
echo "üéâ Arbitron est√° rodando!"
echo "========================"
echo "üìä Dashboard: http://18.219.161.129:3000"
echo "üìö API Docs: http://18.219.161.129:8000/docs"
echo "üîê Security: http://18.219.161.129:3001/health"
echo ""
echo "üìã Comandos √∫teis:"
echo "- Ver logs: docker-compose -f docker-compose.prod.yml logs -f"
echo "- Status: docker-compose -f docker-compose.prod.yml ps"
echo "- Parar: docker-compose -f docker-compose.prod.yml down"
EOF

chmod +x start-arbitron.sh

# Criar script de monitoramento
cat > monitor.sh << 'EOF'
#!/bin/bash

clear
echo "üìä Arbitron System Monitor - 18.219.161.129"
echo "==========================================="
echo "Timestamp: $(date)"
echo ""

# Status dos containers
echo "üê≥ Docker Containers:"
echo "===================="
docker-compose -f docker-compose.prod.yml ps
echo ""

# Status dos servi√ßos
echo "üåê Service Health Check:"
echo "======================="

if curl -f -s http://localhost:3000 > /dev/null; then
    echo "‚úÖ Frontend: http://18.219.161.129:3000 - ONLINE"
else
    echo "‚ùå Frontend: OFFLINE"
fi

if curl -f -s http://localhost:8000/health > /dev/null; then
    echo "‚úÖ API Engine: http://18.219.161.129:8000 - ONLINE"
else
    echo "‚ùå API Engine: OFFLINE"
fi

if curl -f -s http://localhost:3001/health > /dev/null; then
    echo "‚úÖ Security Backend: http://18.219.161.129:3001 - ONLINE"
else
    echo "‚ùå Security Backend: OFFLINE"
fi

# Verificar Redis
if docker-compose -f docker-compose.prod.yml exec -T redis redis-cli ping > /dev/null 2>&1; then
    echo "‚úÖ Redis Cache: ONLINE"
else
    echo "‚ùå Redis Cache: OFFLINE"
fi

# Verificar PostgreSQL
if docker-compose -f docker-compose.prod.yml exec -T postgres pg_isready -U arbitron_user > /dev/null 2>&1; then
    echo "‚úÖ PostgreSQL: ONLINE"
else
    echo "‚ùå PostgreSQL: OFFLINE"
fi

echo ""
echo "üíª System Resources:"
echo "==================="
echo "CPU Usage: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)%"
echo "Memory: $(free -h | awk '/^Mem:/ {print $3 "/" $2 " (" $5 ")"}')"
echo "Disk Usage: $(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')"
echo "Docker Images: $(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | wc -l) images"

echo ""
echo "üîó Quick Access URLs:"
echo "===================="
echo "Dashboard: http://18.219.161.129:3000"
echo "API Docs: http://18.219.161.129:8000/docs"
echo "Security: http://18.219.161.129:3001/health"
EOF

chmod +x monitor.sh

# Criar script de configura√ß√£o de APIs
cat > configure-apis.sh << 'EOF'
#!/bin/bash

echo "üîë Configurador de APIs - Arbitron"
echo "=================================="
echo ""

# Verificar se .env existe
if [ ! -f ".env" ]; then
    echo "‚ùå Arquivo .env n√£o encontrado!"
    exit 1
fi

echo "Este script ir√° configurar suas chaves de API das exchanges."
echo "‚ö†Ô∏è  IMPORTANTE: Use apenas chaves com permiss√µes limitadas!"
echo "   - Somente leitura de dados de mercado"
echo "   - Trading (se necess√°rio)"
echo "   - NUNCA permiss√µes de saque/withdraw"
echo ""

# Fun√ß√£o para configurar exchange
configure_exchange() {
    local exchange=$1
    local exchange_upper=$(echo $exchange | tr '[:lower:]' '[:upper:]')
    
    echo "üìà Configurando $exchange:"
    echo "========================"
    
    read -p "API Key para $exchange: " api_key
    if [ -z "$api_key" ]; then
        echo "‚ö†Ô∏è  API Key vazia, pulando $exchange..."
        return
    fi
    
    read -s -p "Secret Key para $exchange: " secret_key
    echo ""
    
    if [ -z "$secret_key" ]; then
        echo "‚ö†Ô∏è  Secret Key vazia, pulando $exchange..."
        return
    fi
    
    # Atualizar .env
    sed -i "s/${exchange_upper}_API_KEY=.*/${exchange_upper}_API_KEY=$api_key/" .env
    sed -i "s/${exchange_upper}_SECRET_KEY=.*/${exchange_upper}_SECRET_KEY=$secret_key/" .env
    
    echo "‚úÖ $exchange configurado com sucesso!"
    echo ""
}

# Menu de configura√ß√£o
echo "Quais exchanges voc√™ deseja configurar?"
echo "1) Binance"
echo "2) Kraken"
echo "3) Ambas"
echo "4) Pular (manter modo simula√ß√£o)"
echo ""

read -p "Escolha uma op√ß√£o (1-4): " choice

case $choice in
    1)
        configure_exchange "binance"
        ;;
    2)
        configure_exchange "kraken"
        ;;
    3)
        configure_exchange "binance"
        configure_exchange "kraken"
        ;;
    4)
        echo "‚ö†Ô∏è  Configura√ß√£o de APIs pulada."
        echo "   O bot continuar√° em modo simula√ß√£o."
        ;;
    *)
        echo "‚ùå Op√ß√£o inv√°lida!"
        exit 1
        ;;
esac

# Configura√ß√µes de seguran√ßa
echo "üîß Configura√ß√µes de Seguran√ßa:"
echo "=============================="

# Modo simula√ß√£o
read -p "Manter modo simula√ß√£o ativado? (s/n) [s]: " sim_mode
sim_mode=${sim_mode:-s}

if [[ $sim_mode =~ ^[Ss]$ ]]; then
    sed -i "s/SIMULATION_MODE=.*/SIMULATION_MODE=true/" .env
    echo "‚úÖ Modo simula√ß√£o mantido (RECOMENDADO para testes)"
else
    echo "‚ö†Ô∏è  ATEN√á√ÉO: Voc√™ est√° prestes a ativar o modo REAL!"
    echo "   Isso significa que o bot far√° trades reais com dinheiro real."
    read -p "Tem certeza? Digite 'CONFIRMO' para continuar: " confirm
    
    if [ "$confirm" = "CONFIRMO" ]; then
        sed -i "s/SIMULATION_MODE=.*/SIMULATION_MODE=false/" .env
        echo "üö® Modo REAL ativado - USE COM EXTREMA CAUTELA!"
    else
        echo "‚úÖ Modo simula√ß√£o mantido por seguran√ßa."
    fi
fi

# Configurar limites
echo ""
read -p "Valor m√°ximo por trade em USD [100]: " max_trade
max_trade=${max_trade:-100}
sed -i "s/MAX_TRADE_AMOUNT=.*/MAX_TRADE_AMOUNT=$max_trade/" .env

read -p "Lucro m√≠nimo para arbitragem em % [0.5]: " min_profit
min_profit=${min_profit:-0.5}
sed -i "s/MIN_PROFIT_THRESHOLD=.*/MIN_PROFIT_THRESHOLD=$min_profit/" .env

echo ""
echo "‚úÖ Configura√ß√£o conclu√≠da!"
echo "üîÑ Reinicie o Arbitron para aplicar as mudan√ßas:"
echo "   ./start-arbitron.sh"
EOF

chmod +x configure-apis.sh

# Configurar permiss√µes
sudo chown -R $USER:$USER /home/$USER/Arbitron

log_success "Setup conclu√≠do com sucesso!"
echo ""
echo "üéØ ARBITRON CONFIGURADO - IP: 18.219.161.129"
echo "============================================"
echo ""
echo "üìã PR√ìXIMOS PASSOS:"
echo "1. Configure suas chaves de API: ./configure-apis.sh"
echo "2. Inicie o Arbitron: ./start-arbitron.sh"
echo "3. Monitore o sistema: ./monitor.sh"
echo ""
echo "üîó URLs DE ACESSO:"
echo "=================="
echo "üìä Dashboard: http://18.219.161.129:3000"
echo "üìö API Docs: http://18.219.161.129:8000/docs"
echo "üîê Security: http://18.219.161.129:3001/health"
echo ""
echo "üîê INFORMA√á√ïES DE SEGURAN√áA (SALVE EM LOCAL SEGURO):"
echo "=================================================="
echo "JWT Secret: $JWT_SECRET"
echo "DB Password: $DB_PASSWORD"
echo ""
log_warning "IMPORTANTE: Configure as chaves das exchanges antes de usar em produ√ß√£o!"
log_warning "O sistema iniciar√° em MODO SIMULA√á√ÉO por seguran√ßa."
